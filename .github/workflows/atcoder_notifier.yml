name: AtCoder Rating Notifier

on:
  # JSTの土曜日と日曜日の23:00から翌1:00まで、5分おきに実行
  # UTCでは 14:00 から 16:00 (土曜: 6, 日曜: 0)
  schedule:
    - cron: '*/5 14-16 * * 6,0'
  # 手動実行も可能にする
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    # タイムアウト設定（例: 5分）
    timeout-minutes: 5

    # GitHubのSecretsとVariablesを環境変数として設定
    env:
      ATCODER_USER_ID: ${{ vars.ATCODER_USER_ID }}
      DISCORD_WEBHOOK_URLS_NOTIFIER: ${{ secrets.DISCORD_WEBHOOK_URLS_NOTIFIER }}

    steps:
      # ステップ1: リポジトリのコードをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ2: Python環境のセットアップ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ステップ3: 前回の状態ファイルをダウンロード
      - name: Download previous state
        uses: actions/download-artifact@v4
        with:
          name: atcoder-state-${{ env.ATCODER_USER_ID }}
          path: .
        continue-on-error: true

      # ステップ4: Pythonの依存パッケージをインストール
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ステップ5: 通知スクリプトを実行
      - name: Run notifier script
        run: python notifier.py

      # ステップ6: 状態ファイルを保存
      - name: Upload state files
        uses: actions/upload-artifact@v4
        with:
          name: atcoder-state-${{ env.ATCODER_USER_ID }}
          path: |
            last_contest.txt
            notified_today.txt
          retention-days: 30
        if: always()
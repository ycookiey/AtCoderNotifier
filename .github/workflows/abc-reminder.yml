name: ABC Contest Reminder

on:
  schedule:
    # 土曜日と日曜日の 12:00, 16:00, 20:00 JST (UTC+9)
    # UTC時間で指定: 12:00 JST = 03:00 UTC, 16:00 JST = 07:00 UTC, 20:00 JST = 11:00 UTC
    - cron: '0 3 * * 6,0'   # 土日の12:00 JST
    - cron: '0 7 * * 6,0'   # 土日の16:00 JST
    - cron: '0 11 * * 6,0'  # 土日の20:00 JST
  workflow_dispatch:  # 手動実行を可能にする

jobs:
  remind-abc:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
        
    - name: Get latest ABC contest info
      id: get_abc
      run: |
        python scripts/get_latest_abc.py > abc_info.txt
        if [ $? -eq 0 ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "abc_info<<EOF" >> $GITHUB_OUTPUT
          cat abc_info.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Get current time in JST
      id: time
      run: |
        current_hour=$(TZ=Asia/Tokyo date +'%H')
        if [ "$current_hour" = "12" ]; then
          echo "reminder_time=12:00" >> $GITHUB_OUTPUT
          echo "message_type=morning" >> $GITHUB_OUTPUT
        elif [ "$current_hour" = "16" ]; then
          echo "reminder_time=16:00" >> $GITHUB_OUTPUT
          echo "message_type=afternoon" >> $GITHUB_OUTPUT
        elif [ "$current_hour" = "20" ]; then
          echo "reminder_time=20:00" >> $GITHUB_OUTPUT
          echo "message_type=evening" >> $GITHUB_OUTPUT
        fi
        
    - name: Send reminder notification
      if: steps.get_abc.outputs.success == 'true'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python -c "
        import os
        import requests
        import json
        from datetime import datetime
        
        abc_info = '''${{ steps.get_abc.outputs.abc_info }}'''
        reminder_time = '${{ steps.time.outputs.reminder_time }}'
        message_type = '${{ steps.time.outputs.message_type }}'
        
        # メッセージを作成
        lines = abc_info.strip().split('\n')
        contest_name = lines[0].replace('Name: ', '') if len(lines) > 0 else 'ABC Contest'
        contest_url = lines[1].replace('URL: ', '') if len(lines) > 1 else ''
        contest_date = lines[2].replace('Date: ', '') if len(lines) > 2 else ''
        
        if message_type == 'morning':
            message = f'🌅 おはようございます！今日は{contest_name}が開催されます！\\n📅 開催時間: {contest_date}\\n🔗 {contest_url}'
        elif message_type == 'afternoon':
            message = f'☀️ こんにちは！{contest_name}の開催まであと少しです！\\n📅 開催時間: {contest_date}\\n🔗 {contest_url}'
        elif message_type == 'evening':
            message = f'🌙 お疲れ様です！{contest_name}が開催中または間もなく開始です！\\n📅 開催時間: {contest_date}\\n🔗 {contest_url}'
        else:
            message = f'📢 {contest_name}のリマインドです！\\n📅 開催時間: {contest_date}\\n🔗 {contest_url}'
        
        # Discord通知
        discord_url = os.environ.get('DISCORD_WEBHOOK_URL')
        if discord_url:
            payload = {'content': message}
            try:
                response = requests.post(discord_url, json=payload, timeout=10)
                if response.status_code == 204:
                    print('Discord notification sent successfully')
                else:
                    print(f'Discord notification failed: {response.status_code}')
            except Exception as e:
                print(f'Discord notification error: {e}')
        else:
            print('No Discord webhook URL configured. Message would be:')
            print(message)
        "
        
    - name: Log reminder execution
      run: |
        echo "ABC Reminder executed at $(TZ=Asia/Tokyo date)"
        echo "Reminder time: ${{ steps.time.outputs.reminder_time }}"
        echo "Message type: ${{ steps.time.outputs.message_type }}"
        if [ "${{ steps.get_abc.outputs.success }}" = "true" ]; then
          echo "ABC contest info found and notification sent"
        else
          echo "No ABC contest info found"
        fi